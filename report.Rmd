---
title: "AMR Country Hotspots"
output:
  rmdformats::html_clean:
    lightbox: TRUE
    gallery: TRUE
    thumbnails: FALSE
    keep_md: TRUE
---
```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width=20)
library(tidyverse)
library(brms)
library(bayesplot)
library(here)
h <- here::here
source(h("R/functions.R"))

color_scheme_set("viridis")

amr <- read_rds(h("model/mice-imputation.rds")) %>% mice::complete(.)
fit_combined <- read_rds(h("model/fit_combined.rds"))
fit_all <- read_rds( h("model/fit_all.rds"))
me_combined <- read_rds(h("model/fit_combined_marginal_effects.rds"))
me_all <- read_rds(h("model/fit_all_marginal_effects.rds"))

```

```{r sum}
summary(fit_combined)
```

```{r diagnostics}
# Trace Plots
stanplot(fit_combined, type = "trace")

y <- amr$n_amr_events
yrep <- posterior_predict(fit_combined, nsamples = 1000) 
yord <- order(y)
yrep <- yrep[,yord]
y <- y[yord]

ppc_dens_overlay(y, yrep) + scale_x_continuous(limits = c(0, 50)) + labs(title = "Density Overlay")

prop_zero <- function(x) mean(x == 0)
ppc_stat(y, yrep, stat = "prop_zero", binwidth = 0.005) + labs(title = "Proportion Zeros")


int_dat <- ppc_intervals_data(y, yrep) 
int_dat <- int_dat %>%
  filter(y_obs>0) %>%
  mutate(in_50 = y_obs >= l & y_obs <= h,
         in_90 = y_obs >= ll & y_obs <= hh)

p50 <- round(100*sum(int_dat$in_50)/nrow(int_dat))
p90 <- round(100*sum(int_dat$in_90)/nrow(int_dat))

ppc_intervals(y, yrep) + labs(title = "Observations versus Predictions (individual observations)", caption = paste0("dark line = 50% probability\nfaded line = 90% probability\n", p50, "% non-zeros in 50% prob\n", p90,  "% non-zeros in 90% prob"))


y_grped <- tibble(y) %>%
  mutate(grp = cut(y, breaks = c(0,  1, 10, 20, 50, Inf), right = FALSE)) %>%
  group_by(grp) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  mutate(grp = paste0(grp, " (n = ", n, ")")) %>%
  select(-n)

y_grped_sum <- y_grped %>%
  group_by(grp) %>%
  summarize(med = median(y)) %>%
  mutate(ytype = "y")

colnames(yrep) <- y_grped$grp

yrep_grped <- map_df(unique(colnames(yrep)), function(x){
  
  grp <- yrep[, x]
  med <- median(grp)
  prob_50_upper <- quantile(grp, 0.75)
  prob_50_lower <- quantile(grp, 0.25)
  prob_90_upper <- quantile(grp, 0.95)
  prob_90_lower <- quantile(grp, 0.05)
  
  tibble(grp = x, med, prob_50_upper, prob_50_lower, prob_90_upper, prob_90_lower, ytype = "yrep")
  
})

yall <- bind_rows(y_grped_sum, yrep_grped)

ggplot(data = yall, aes(x = grp)) + 
  geom_errorbar(aes(ymin = prob_50_lower, ymax = prob_50_upper), color = color_scheme_get()[2], width=0, size = 1.5) +
  geom_errorbar(aes(ymin = prob_90_lower, ymax = prob_90_upper), color = color_scheme_get()[2], width=0, alpha = 0.3, size = 1.5) +
  geom_point(aes(x = grp, y = med, color = ytype, fill = ytype), pch=21, size = 3) +
  scale_fill_manual(values = c("y" = unname(color_scheme_get()[6]), "yrep" = unname(color_scheme_get()[1]))) +
  scale_color_manual(values = c("y" = unname(color_scheme_get()[5]), "yrep" = unname(color_scheme_get()[2]))) +
  labs(title = "Observations versus Predictions(grouped by intervals)", caption = "dark line = 50% probability; faded line = 90% probability; points are medians", x = "", y = "", color = "", fill = "")


```

```{r plots}
# partial effects - each model over data range
me_all2 <- imap_dfr(me_all, function(x, y){
  get_me_dat(x) %>%
    mutate(iteration = y) 
})

me_all2_avg <- me_all2 %>%
  group_by(value, var) %>%
  summarize(mean = mean(estimate__)) %>%
  ungroup() 

ggplot(me_all2, aes(x = value)) + 
  geom_line(aes(y = estimate__, group = iteration), color = "cornflowerblue", size=.5, alpha = 0.4) +
  geom_line(data = me_all2_avg, aes(x = value, y = mean)) +
  facet_wrap(. ~ var,  scales = "free") + 
  labs(x = "", y = "Count AMR Events", title = "Partial Effects of Predictor Variables", caption = "Blue lines represent individual model iterations; black line is average model") +
  theme_minimal() 

ggsave(filename = h("plots/marginal_effects_multi.png"), width = 22, height = 12)

# separate zi from poisson

raw <- amr %>% select(-iso3c, -ab_import_perc)
amr_tidy <- gather(raw, key ="var", value = "x")
means <- map_dbl(raw, ~mean(., na.rm = T))

beta_samples <- posterior_samples(fit_combined, subset = sample(nsamples(fit_combined), 500, replace = F)) 

zi_vars <- c("ln_pubs_sum_per_capita", "ln_gdp_per_capita", "ln_population")
out_zi <- map_dfr(zi_vars, function(var){
  
  minx <- raw %>% pull(var) %>% min(., na.rm = T)
  maxx <- raw %>% pull(var) %>% max(., na.rm = T)
  seqx <- seq(from = minx, to = maxx, length.out = 100)
  
  betas <- as.matrix(beta_samples[,grep("zi", colnames(beta_samples))])
  #betas <- betas[,grep(var, colnames(betas))]
  
  X <- matrix(
    c(1, colMeans(as.matrix(raw[,zi_vars]))),
    nrow = length(zi_vars) + 1, ncol = length(seqx),
  )
  rownames(X) <- c("Intercept", zi_vars)
  X[var, ] <- seqx
  Y <- plogis(betas %*% X)
  out <- as_tibble(Y) %>% 
    mutate(samp = 1:nrow(Y)) %>% 
    gather("x", "y", -samp) %>% 
    mutate(x = rep(seqx, each = nrow(betas)),
           var = var)
  
  return(out)
})

out_zi_sum <- out_zi %>% 
  group_by(x, var) %>% 
  summarise(med = median(y),
            lo = quantile(y, .025),
            hi = quantile(y, .975))

p_zi_lines <- 
  ggplot(data = out_zi) + 
  geom_line(aes(x = x, y = y, group = samp), color = "lightsalmon", alpha = 0.1) + #For lots of lines
  geom_rug(data = filter(amr_tidy, var %in% zi_vars), mapping = aes(x = x)) + 
  facet_wrap(var ~ ., scales = "free", drop = FALSE,  ncol = 3) +
  labs(y = "Logisitic Prob of No Response", x = "", main = "Logistic Model (zi)") +
  theme_minimal()

p_zi_ribbon <- 
  ggplot(data = out_zi_sum) +
  geom_ribbon(aes(x = x, ymin = lo, ymax = hi), fill = "lightsalmon", col = NA, alpha = 0.2) +
  geom_line(aes(x = x, y = med), color = "lightsalmon") +
  geom_rug(data = filter(amr_tidy, var %in% zi_vars), mapping = aes(x = x)) + 
  facet_wrap(var ~ ., scales = "free", drop = FALSE,  ncol = 3) +
  labs(y = "Logisitic Prob of No Response", x = "", main = "Logistic Model (zi)") +
  theme_minimal()

p_zi_me <- me_combined %>% 
  get_me_dat(.) %>%
  filter(var %in% zi_vars) %>%
  ggplot(., aes(x = value, y = estimate__)) + 
  geom_line(color = "lightsalmon") +
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha = 0.2, fill = "lightsalmon") +
  geom_rug(data = filter(amr_tidy, var %in% zi_vars), mapping = aes(x = x, y = 0)) + 
  facet_wrap(var ~ .,  scales = "free", drop = FALSE, nrow = 1) + 
  labs(x = "", y = "Count AMR Events (marginal_effects)") +
  theme_minimal() 

gridExtra::grid.arrange(p_zi_ribbon, p_zi_me)

ggsave(plot = gridExtra::grid.arrange(p_zi_ribbon, p_zi_me), 
       filename = h("plots/compare_zi.png"), width = 22, height = 12)

pois_vars <- c("ln_livestock_consumption_kg_per_pcu", "ln_livestock_pcu", "ln_migrant_pop_perc", "ab_export_perc", "health_expend_perc", "human_consumption_ddd", "ln_gdp_per_capita")
out_pois <- map_dfr(pois_vars, function(var){
  
  minx <- raw %>% pull(var) %>% min(., na.rm = T)
  maxx <- raw %>% pull(var) %>% max(., na.rm = T)
  seqx <- seq(from = minx, to = maxx, length.out = 100)
  
  betas <- cbind(as.matrix(beta_samples[,c(grep("b_[^z]", colnames(beta_samples)))]), 1)

  X <- matrix(
    c(1, colMeans(as.matrix(raw[,c(pois_vars, "ln_population")]))),
    nrow = length(pois_vars) + 2, ncol = length(seqx),
  )
  rownames(X) <- c("Intercept", pois_vars, "offset") 
  X[var, ] <- seqx
  Y <- exp(betas %*% X)
  out <- as_tibble(Y) %>% 
    mutate(samp = 1:nrow(Y)) %>% 
    gather("x", "y", -samp) %>% 
    mutate(x = rep(seqx, each = nrow(betas)),
           var = var)
  
  return(out)
})

out_pois_sum <- out_pois %>% 
  group_by(x, var) %>% 
  summarise(med = median(y),
            lo = quantile(y, .025),
            hi = quantile(y, .975))

p_pois_lines <-  
  ggplot(data = out_pois) + 
  geom_line(aes(x = x, y = y, group = samp), color = "green", alpha = 0.1) + #For lots of lines
  geom_rug(data = filter(amr_tidy, var %in% pois_vars), mapping = aes(x = x, y = 0)) + 
  facet_wrap(var ~ ., scales = "free", drop = FALSE,  nrow = 1) +
  labs(y = "Event Count if Reported", x = "", main = "Poisson Model (zi)") +
  theme_minimal()

p_pois_ribbon <- 
  ggplot(data = out_pois_sum) +
  geom_ribbon(aes(x = x, ymin = lo, ymax = hi), fill = "green", col = NA, alpha = 0.2) +
  geom_line(aes(x = x, y = med), color = "green") +
  geom_rug(data = filter(amr_tidy, var %in% pois_vars), mapping = aes(x = x, y = NA_real_)) + 
  facet_wrap(var ~ ., scales = "free", drop = FALSE,  nrow = 1) +
  labs(y = "Event Count if Reported", x = "", main = "Poisson Model (zi)") +
  theme_minimal()

p_pois_me <- me_combined %>% 
  get_me_dat(.) %>%
  filter(var %in% pois_vars) %>%
  ggplot(., aes(x = value, y = estimate__)) + 
  geom_line(color = "green") +
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha = 0.2, fill = "green") +
  facet_wrap(var ~ .,  scales = "free", drop = FALSE, nrow = 1) + 
  labs(x = "", y = "Count AMR Events (marginal_effects)") +
  theme_minimal() 

gridExtra::grid.arrange(p_pois_ribbon, p_pois_me)

ggsave(plot = gridExtra::grid.arrange(p_pois_ribbon, p_pois_me), filename = h("plots/compare_pois.png"), width = 22, height = 12)

```

