library(tidyverse)
library(magrittr)
library(httr)
library(lubridate)
library(wbstats)
library(here)
library(countrycode)

url <- "https://raw.githubusercontent.com/ecohealthalliance/amr-db/master/data/events_db.csv"
events <- GET(url, authenticate("emmamendelsohn", Sys.getenv("GITHUB_PAT")))
events <- read_csv(content(events, "text"))

#-----------------Country-wide data-----------------
# Rename a few countries in our data to match WB
events %<>%
  mutate(study_country = replace(study_country, study_country == "palestine", "israel"),
         study_country = replace(study_country, study_country == "taiwan", "china")
  )

# Get iso3c codes for countries
events %<>%
  mutate(iso3c = countrycode(sourcevar = study_country,
                             origin = "country.name",
                             destination = "iso3c"))

# Summarize counts
events_by_country <- events %>%
  group_by(iso3c) %>%
  count(name = "n_amr_events") %>%
  ungroup() %>%
  na.omit()
#-----------------World Bank data-----------------
# Population and GDP
# SP.POP.TOTL = Population, total
# NY.GDP.MKTP.CD = GDP (current US$)
wbd <- wb(indicator = c("SP.POP.TOTL", "NY.GDP.MKTP.CD"), startdate = 2015, enddate = 2015, return_wide = TRUE) %>%
  select(-country, -iso2c, -date) %>%
  rename(NY.GDP.MKTP.CD.2015 = NY.GDP.MKTP.CD,
         SP.POP.TOTL.2015 = SP.POP.TOTL)

#-----------------Pubcrawler data-----------------
pubcrawl_weights <- read_csv(here::here("pubcrawler_country.csv")) %>% # generated by Toph on 2/1/19
  mutate(country = tolower(country),
         country = fct_recode(country, 
                              belize = "belice", 
                              brazil = "brasil",
                              `central african republic` = "cen african rep", 
                              `czech republic` = "czech r",
                              `dominican republic` = "dominican r", 
                              `united kingdom` = "england",
                              mauritania = "mauretania", 
                              morocco = "moracco",
                              `western sahara` = "morocco (includes western sahara)",
                              philippines = "philippine", 
                              tunisia = "tunesia"),
        iso3c = countrycode(sourcevar = country,
                                    origin = "country.name",
                                    destination = "iso3c")) %>%
  select(-country)

#-----------------Pubcrawler data-----------------
amr <- left_join(events_by_country, pubcrawl_weights) %>%
  left_join(wbd) %>%
  mutate(country = countrycode::countrycode(sourcevar = iso3c,
                                              origin = "iso3c",
                                              destination = "country.name"), 
         continent = countrycode::countrycode(sourcevar = iso3c,
                                              origin = "iso3c",
                                              destination = "continent"))
         
write_csv(amr, here::here("country_level_amr.csv"))
