library(tidyverse)
library(magrittr)
library(httr)
library(jsonlite)
library(here)
library(countrycode)

h <- here::here

url <- "https://raw.githubusercontent.com/ecohealthalliance/amr-db/master/data/events_db.csv"
events <- GET(url, authenticate("emmamendelsohn", Sys.getenv("GITHUB_PAT")))
events <- read_csv(content(events, "text"))

#-----------------Country-wide data-----------------
# Rename a few countries in our data to match WB
# events %<>%
#   mutate(study_country = replace(study_country, study_country == "palestine", "israel"),
#          study_country = replace(study_country, study_country == "taiwan", "china")
#   )

# Get iso3c codes for countries
events %<>%
  mutate(iso3c = countrycode(sourcevar = study_country,
                             origin = "country.name",
                             destination = "iso3c"))

# Summarize counts
events_by_country <- events %>%
  group_by(iso3c) %>%
  count(name = "n_amr_events") %>%
  ungroup() 
#-----------------World Bank data-----------------
# 2015
# Population and GDP
# SP.POP.TOTL = Population, total
# SM.POP.TOTL = International migrant stock, total (number of people born in a country other than that in which they live. It also includes refugees). United Nations Population Division, Trends in Total Migrant Stock: 2012 Revision.
# NY.GDP.MKTP.CD = GDP (current US$)
# AG.LND.AGRI.ZS = Agricultural land (% of land area) : Food and Agriculture Organization, electronic files and web site.
# AG.PRD.LVSK.XD = Livestock production index (2004-2006 = 100) : Food and Agriculture Organization, electronic files and web site.
# SH.XPD.CHEX.GD.ZS = Current health expenditure (% of GDP) : World Health Organization Global Health Expenditure database
# AG.LND.TOTL.K2 = Land area (sq. km) : Land area is a country's total area, excluding area under inland water bodies

indicator = c("SP.POP.TOTL", 
              "SM.POP.TOTL",
              "NY.GDP.MKTP.CD",
              "AG.LND.AGRI.ZS",
              #"AG.PRD.LVSK.XD",
              "SH.XPD.CHEX.GD.ZS",
              "AG.LND.TOTL.K2"
)

wbd <- map_df(indicator, function(x){
  tmp <- fromJSON(paste0("http://api.worldbank.org/v2/country/all/indicator/", x, "?date=2015:2015&per_page=20000&format=json"))
  tmp[[2]] %>% 
    select(value, countryiso3code) %>%
    mutate(param = tmp[[2]][[1]]$id) %>%
    as_tibble() %>%
    filter(countryiso3code != "")
})

wbd %<>%
  na.omit() %>%
  spread(key = param, value = value) %>%
  mutate(SM.POP.TOTL = 100 * SM.POP.TOTL/SP.POP.TOTL) %>% #calc migrant % of population
  rename(population = SP.POP.TOTL,
         migrant_pop_perc = SM.POP.TOTL,
         gdp_dollars = NY.GDP.MKTP.CD,
         ag_land_perc = AG.LND.AGRI.ZS,
         #livestock_index = AG.PRD.LVSK.XD,
         health_expend_perc = SH.XPD.CHEX.GD.ZS,
         land_area_km2 = AG.LND.TOTL.K2,
         iso3c = countryiso3code)

#-----------------Food and Agriculture Organization------------
# 2015
# Download 6/24 from http://www.fao.org/faostat/en/#data/GU
fao <- read_csv(h("data/FAOSTAT_data_6-24-2019.csv")) %>%
  filter(Element == "Manure applied to soils (N content)",
         Area != "China, mainland") %>%
  mutate(iso3c = countrycode(sourcevar = Area,
                      origin = "country.name",
                      destination = "iso3c")) %>%
  select(iso3c, manure_soils_kg = Value) %>%
  na.omit()
#-----------------Observatory of Economic Complexity------------
# 2015
# Visualization: https://atlas.media.mit.edu/en/visualize/tree_map/hs92/export/show/all/2941/2015/
# Values in billions
oec <- read_json("https://atlas.media.mit.edu/hs92/export/2015/show/all/2941/")$data 
oec <- map_df(oec, function(x){
  
  import <- ifelse(is.null(x$import_val), 0, x$import_val)
  export <- ifelse(is.null(x$export_val), 0, x$export_val)
  
  tibble(iso3c = toupper(substr(x$origin_id, 3, 5)), 
         #ab_import_dollars = import, 
         ab_export_dollars = export)
}) 

#-----------------Pubcrawler data-----------------
# Values are unitless
pubcrawl_weights <- read_csv(h("data/pubcrawler_country.csv")) %>% # generated by Toph on 2/1/19
  mutate(country = tolower(country),
         country = fct_recode(country, 
                              belize = "belice", 
                              brazil = "brasil",
                              `central african republic` = "cen african rep", 
                              `czech republic` = "czech r",
                              `dominican republic` = "dominican r", 
                              `united kingdom` = "england",
                              mauritania = "mauretania", 
                              morocco = "moracco",
                              `western sahara` = "morocco (includes western sahara)",
                              philippines = "philippine", 
                              tunisia = "tunesia"),
         iso3c = countrycode(sourcevar = country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  filter(!(iso3c == "MRT" & pubs_sum==0)) %>%
  select(-country) %>%
  na.omit()

#-----------------Language by country-----------------
lang <- read_csv(h("data/wikipedia-language-by-country.csv"), skip = 1) %>% # 3/18/19 from https://wikitable2csv.ggor.de/
  select(Country, `Official language`) %>%
  filter(!Country %in% c("Sovereign Military Order of Malta", "Somaliland")) %>%
  mutate(english_spoken = grepl("English", `Official language`, ignore.case = TRUE),
         iso3c = countrycode(sourcevar = Country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  na.omit() %>%
  select(iso3c, english_spoken) %>%
  distinct()

#-----------------Human Consumption data-----------------
# 2014
# From IQVIA MIDAS, as provided in Collignon EA 2018 supp data via personal correspondence 
# Values are Total defined daily dose (DDD) per capita
# Defined Daily Dose (DDD): The assumed average maintenance dose per day for a drug used for its main indication in adults.
consumption <- readxl::read_xlsx(h("data/Supplementary Table 1 Spreadsheet Data[2].xlsx")) %>%
  select(`International Organization for Standardization (ISO)*`, 
         `CCDEP Usage Per Capita (Units of usage are on average 45% of DDD measured by ECDC)`) %>%
  rename(iso3c = `International Organization for Standardization (ISO)*`, 
         ab_consumption_ddd =  `CCDEP Usage Per Capita (Units of usage are on average 45% of DDD measured by ECDC)`) %>%
  na.omit() %>%
  filter(iso3c != "na") 

#-----------------Livestock Consumption data-----------------
# 2010 
# Supp data from VanBoeckelEA 2015 https://www.pnas.org/content/112/18/5649
livestock <- read_csv(h("data/VanBoeckelEA_total_annual_sales.csv")) %>%
  group_by(country) %>%
  summarize(livestock_ab_sales_kg = mean(livestock_ab_sales_kg)) %>% # average multiple values by country (all are very close)
  ungroup() %>%
  mutate(iso3c = countrycode(sourcevar = country,
                            origin = "country.name",
                            destination = "iso3c")) %>%
  select(-country)

#-----------------All countries-----------------
all_countries <- map_data("world") %>%
  mutate(iso3c = countrycode(sourcevar = region,
                             origin = "country.name",
                             destination = "iso3c"))  %>%
  select(iso3c) %>% na.omit() %>% distinct() 


#-----------------All data-----------------
amr <- all_countries %>%
  left_join(events_by_country) %>%
  mutate(n_amr_events = replace_na(n_amr_events, 0)) %>%
  left_join(pubcrawl_weights) %>%
  left_join(wbd) %>%
  left_join(oec) %>%
  left_join(lang) %>%
  left_join(consumption) %>%
  left_join(livestock) %>%
  left_join(fao) %>%
  mutate(n_amr_events = ifelse(is.na(n_amr_events), 0 , n_amr_events),
         country = countrycode::countrycode(sourcevar = iso3c,
                                            origin = "iso3c",
                                            destination = "country.name"), 
         region = countrycode::countrycode(sourcevar = iso3c,
                                           origin = "iso3c",
                                           destination = "region"), 
         continent = countrycode::countrycode(sourcevar = iso3c,
                                              origin = "iso3c",
                                              destination = "continent"))

# Post process
amr %<>%
  mutate(ab_export_perc = 100 * ab_export_dollars/gdp_dollars) %>%
  mutate(manure_soils_kg_per_km2 = manure_soils_kg/(land_area_km2 * ag_land_perc/100)) %>%
  select(-ab_export_dollars, -land_area_km2, -manure_soils_kg)
  
write_csv(amr, h("country_level_amr.csv"))

  
  