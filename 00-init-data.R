library(tidyverse)
library(magrittr)
library(httr)
library(jsonlite)
library(here)
library(countrycode)
library(raster)
library(sf)
library(rnaturalearth)

h <- here::here

url <- "https://raw.githubusercontent.com/ecohealthalliance/amr-db/master/data/events_db.csv"
events <- GET(url, authenticate("emmamendelsohn", Sys.getenv("GITHUB_PAT")))
events <- read_csv(content(events, "text"))

#-----------------Country-wide data-----------------
# Get iso3c codes for countries
events %<>%
  mutate(iso3c = countrycode(sourcevar = study_country,
                             origin = "country.name",
                             destination = "iso3c"))

# Summarize counts
events_by_country <- events %>%
  group_by(iso3c) %>%
  count(name = "n_amr_events") %>%
  ungroup() 
#-----------------World Bank data-----------------
# 2015
# Population and GDP
# SP.POP.TOTL = Population, total
# SM.POP.TOTL = International migrant stock, total (number of people born in a country other than that in which they live. It also includes refugees). United Nations Population Division, Trends in Total Migrant Stock: 2012 Revision.
# NY.GDP.MKTP.CD = GDP (current US$)
# AG.LND.AGRI.ZS = Agricultural land (% of land area) : Food and Agriculture Organization, electronic files and web site.
# AG.PRD.LVSK.XD = Livestock production index (2004-2006 = 100) : Food and Agriculture Organization, electronic files and web site.
# SH.XPD.CHEX.GD.ZS = Current health expenditure (% of GDP) : World Health Organization Global Health Expenditure database
# AG.LND.TOTL.K2 = Land area (sq. km) : Land area is a country's total area, excluding area under inland water bodies

indicator = c("SP.POP.TOTL", 
              "SM.POP.TOTL",
              "NY.GDP.MKTP.CD",
              #"AG.LND.AGRI.ZS",
              #"AG.PRD.LVSK.XD",
              "SH.XPD.CHEX.GD.ZS"#,
              #"AG.LND.TOTL.K2"
)

wbd <- map_df(indicator, function(x){
  tmp <- fromJSON(paste0("http://api.worldbank.org/v2/country/all/indicator/", x, "?date=2015:2015&per_page=20000&format=json"))
  tmp[[2]] %>% 
    dplyr::select(value, countryiso3code) %>%
    mutate(param = tmp[[2]][[1]]$id) %>%
    as_tibble() %>%
    filter(countryiso3code != "")
})

wbd %<>%
  na.omit() %>%
  spread(key = param, value = value) %>%
  mutate(SM.POP.TOTL = 100 * SM.POP.TOTL/SP.POP.TOTL) %>% #calc migrant % of population
  rename(population = SP.POP.TOTL,
         migrant_pop_perc = SM.POP.TOTL,
         gdp_dollars = NY.GDP.MKTP.CD,
         #ag_land_perc = AG.LND.AGRI.ZS,
         #livestock_index = AG.PRD.LVSK.XD,
         health_expend_perc = SH.XPD.CHEX.GD.ZS,
         #land_area_km2 = AG.LND.TOTL.K2,
         iso3c = countryiso3code)

#-----------------Food and Agriculture Organization------------
# 2015
# Download 6/24 from http://www.fao.org/faostat/en/#data/GU
# fao <- read_csv(h("data/FAOSTAT_data_6-24-2019.csv")) %>%
#   filter(Element == "Manure applied to soils (N content)",
#          Area != "China, mainland") %>%
#   mutate(iso3c = countrycode(sourcevar = Area,
#                       origin = "country.name",
#                       destination = "iso3c")) %>%
#   dplyr::select(iso3c, manure_soils_kg = Value) %>%
#   na.omit()
#-----------------Observatory of Economic Complexity------------
# 2015
# Visualization: https://atlas.media.mit.edu/en/visualize/tree_map/hs92/export/show/all/2941/2015/
# Values in billions
oec <- read_json("https://atlas.media.mit.edu/hs92/export/2015/show/all/2941/")$data 
oec <- map_df(oec, function(x){
  
  import <- ifelse(is.null(x$import_val), 0, x$import_val)
  export <- ifelse(is.null(x$export_val), 0, x$export_val)
  
  tibble(iso3c = toupper(substr(x$origin_id, 3, 5)), 
         ab_import_dollars = import, 
         ab_export_dollars = export)
}) 

#-----------------Pubcrawler data-----------------
# Pubcrawler reporting effort index, as used in Hotspots II, aggregated by country.
# https://www.nature.com/articles/s41467-017-00923-8#MOESM1
# Values are unitless
pubcrawl_weights <- read_csv(h("data/pubcrawler_country.csv")) %>% # generated by Toph on 2/1/19
  mutate(country = tolower(country),
         country = fct_recode(country, 
                              belize = "belice", 
                              brazil = "brasil",
                              `central african republic` = "cen african rep", 
                              `czech republic` = "czech r",
                              `dominican republic` = "dominican r", 
                              `united kingdom` = "england",
                              mauritania = "mauretania", 
                              morocco = "moracco",
                              `western sahara` = "morocco (includes western sahara)",
                              philippines = "philippine", 
                              tunisia = "tunesia"),
         iso3c = countrycode(sourcevar = country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  filter(!(iso3c == "MRT" & pubs_sum==0)) %>%
  dplyr::select(-country) %>%
  na.omit()

#-----------------GRITS ProMED-----------------
promed_weights <- read_csv(h("data/promed_mentions.csv")) %>%
  mutate(iso3c = countrycode(sourcevar = country_code,
                             origin = "iso2c",
                             destination = "iso3c")) %>%
  dplyr::select(-country_code, promed_mentions = mentions)
#-----------------Language by country-----------------
lang <- read_csv(h("data/wikipedia-language-by-country.csv"), skip = 1) %>% # 3/18/19 from https://wikitable2csv.ggor.de/
  dplyr::select(Country, `Official language`) %>%
  filter(!Country %in% c("Sovereign Military Order of Malta", "Somaliland")) %>%
  mutate(english_spoken = grepl("English", `Official language`, ignore.case = TRUE),
         iso3c = countrycode(sourcevar = Country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  na.omit() %>%
  dplyr::select(iso3c, english_spoken) %>%
  distinct()

#-----------------Human Consumption data-----------------
# 2014
# From IQVIA MIDAS, as provided in Collignon EA 2018 supp data via personal correspondence 
# Values are Total defined daily dose (DDD) per capita
# Defined Daily Dose (DDD): The assumed average maintenance dose per day for a drug used for its main indication in adults.
consumption <- readxl::read_xlsx(h("data/Supplementary Table 1 Spreadsheet Data[2].xlsx")) %>%
  dplyr::select(`International Organization for Standardization (ISO)*`, 
                `CCDEP Usage Per Capita (Units of usage are on average 45% of DDD measured by ECDC)`) %>%
  rename(iso3c = `International Organization for Standardization (ISO)*`, 
         human_consumption_ddd =  `CCDEP Usage Per Capita (Units of usage are on average 45% of DDD measured by ECDC)`) %>%
  na.omit() %>%
  filter(iso3c != "na") 

#-----------------Livestock Consumption data-----------------
# 2010 
# Supp data from VanBoeckelEA 2015 https://www.pnas.org/content/112/18/5649
livestock <- read_csv(h("data/VanBoeckelEA_total_annual_sales.csv")) %>%
  group_by(country) %>%
  summarize(livestock_ab_sales_kg = mean(livestock_ab_sales_kg)) %>% # average multiple values by country (all are very close)
  ungroup() %>%
  mutate(iso3c = countrycode(sourcevar = country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  dplyr::select(-country)
#-----------------Livestock Consumption data-----------------
# 2010 
# Supp data from VanBoeckelEA 2015 https://www.pnas.org/content/112/18/5649
# Future work may disaggregate by livestock type - cattle, chickens, pigss
# Raster obtained via personal communication with authors
# livestock <- raster('data/antimicrobial_use/mgabx_Log10p1.tif') # units are log10[(mg/pixel)+1]
# livestock$livestock_consumption_mg_per_px <- (10^livestock$mgabx_Log10p1)-1
# livestock$livestock_consumption_kg_per_px <- livestock$livestock_consumption_mg_per_px/1000000
# 
# countries <- ne_countries(scale = "large") # for extracting
# 
# livestock2 <- extract(x = livestock, y = countries, layer = 3, 
#                       fun = sum, na.rm = TRUE, df = TRUE) # sum for kg for each country
# 
# livestock3 <- livestock2 %>% 
#   mutate(country = countries$name,
#          iso_a3_eh = countries$iso_a3_eh,
#          iso3c = countrycode(sourcevar = country,
#                              origin = "country.name",
#                              destination = "iso3c"),
#          iso3c = ifelse(is.na(iso3c), iso_a3_eh, iso3c)) %>%
#   drop_na(iso3c) %>% 
#   arrange(-livestock_consumption_kg_per_px) %>%
#   dplyr::select(iso3c, livestock_consumption_kg = livestock_consumption_kg_per_px) %>% 
#   group_by(iso3c) %>% 
#   summarize(livestock_consumption_kg = sum(livestock_consumption_kg)) %>% # accounting for countries that were split up (SOM, CYP)
#   ungroup()
# 
# # Read in json pcu data - scraped from https://resistancemap.cddep.org/AnimalUse.php - 07/29/2019
# pcu <- fromJSON(h("data", "resistance-map.json")) %>% # value is mg/pcu
#   mutate(livestock_consumption_kg_per_pcu = value/1000000) %>%
#   dplyr::select(iso3c = `iso-a3`, livestock_consumption_kg_per_pcu)
# 
# livestock3 <- livestock3 %>%
#   right_join(pcu) %>%
#   mutate(livestock_pcu = livestock_consumption_kg/livestock_consumption_kg_per_pcu) %>%
#   filter(!is.na(livestock_pcu), !is.infinite(livestock_pcu), !is.nan(livestock_pcu)) #%>% # unclear if no livestock or no consumption
#   #dplyr::select(-livestock_consumption_kg)
#-----------------Tourism data-----------------
# 2015
# World Tourism Organization (2019), Compendium of Tourism Statistics dataset [Electronic], UNWTO, Madrid, data updated on 11/01/2019.
# Outbound tourism downloaded from https://www.e-unwto.org/doi/suppl/10.5555/unwtotfb0000290019952017201901
tour_outbound <- readxl::read_xlsx(h("data/0000290019952017201901.xlsx"), sheet = 1, skip = 5) %>% # Outbound tourism - Departures of visitors (overnight visitors -tourists- and same-day visitors -excursionists-)… Thousands
  dplyr::select(COUNTRY, tourism_outbound = `2015`) %>%
  filter(tourism_outbound != "..")
tour_inbound <- readxl::read_xlsx(h("data/0000270019952017201901.xlsx"), sheet = 1, skip = 5) %>% # Inbound tourism - Arrivals of non-resident visitors (overnight visitors -tourists- and same-day visitors -excur… Thousands
  dplyr::select(COUNTRY, tourism_inbound = `2015`) %>%
  filter(tourism_inbound != "..")

tourism <- full_join(tour_outbound, tour_inbound) %>%
  mutate_at(vars("tourism_outbound", "tourism_inbound"), ~as.numeric(.)) %>%
    mutate(iso3c = countrycode(sourcevar = COUNTRY,
                             origin = "country.name",
                             destination = "iso3c")) %>%
      dplyr::select(-COUNTRY)
#-----------------All countries-----------------
all_countries <- map_data("world") %>%
  mutate(iso3c = countrycode(sourcevar = region,
                             origin = "country.name",
                             destination = "iso3c"))  %>%
  dplyr::select(iso3c) %>% na.omit() %>% distinct() 

#-----------------All data-----------------
amr <- all_countries %>%
  left_join(events_by_country) %>%
  mutate(n_amr_events = replace_na(n_amr_events, 0)) %>%
  left_join(pubcrawl_weights) %>%
  left_join(promed_weights) %>%
  left_join(wbd) %>%
  left_join(oec) %>%
  left_join(lang) %>%
  left_join(consumption) %>%
  left_join(livestock) %>%
  #left_join(livestock3) %>%
  left_join(tourism) %>%
  #left_join(fao) %>%
  mutate(n_amr_events = ifelse(is.na(n_amr_events), 0 , n_amr_events),
         country = countrycode::countrycode(sourcevar = iso3c,
                                            origin = "iso3c",
                                            destination = "country.name"), 
         region = countrycode::countrycode(sourcevar = iso3c,
                                           origin = "iso3c",
                                           destination = "region"), 
         continent = countrycode::countrycode(sourcevar = iso3c,
                                              origin = "iso3c",
                                              destination = "continent"))

# Post process
amr %<>%
  mutate(ab_export_perc = 100 * ab_export_dollars/gdp_dollars,
         ab_import_perc = 100 * ab_import_dollars/gdp_dollars,
         livestock_consumption_kg_per_capita = livestock_ab_sales_kg/population,
         gdp_per_capita = gdp_dollars/population,
         tourism_outbound_perc = 100 * (tourism_outbound*1000)/population,
         tourism_inbound_perc = 100 * (tourism_inbound*1000)/population,
         pubs_sum_per_capita = pubs_sum/population,
         promed_mentions_per_capita = promed_mentions/population
         ) %>%
  dplyr::select(-ab_export_dollars, -ab_import_dollars, -tourism_outbound, -tourism_inbound, -livestock_ab_sales_kg)

write_csv(amr, h("country_level_amr.csv"))


