library(tidyverse)
library(magrittr)
library(httr)
library(jsonlite)
library(here)
library(countrycode)

h <- here::here

url <- "https://raw.githubusercontent.com/ecohealthalliance/amr-db/master/data/events_db.csv"
events <- GET(url, authenticate("emmamendelsohn", Sys.getenv("GITHUB_PAT")))
events <- read_csv(content(events, "text"))

#-----------------Country-wide data-----------------
# Rename a few countries in our data to match WB
events %<>%
  mutate(study_country = replace(study_country, study_country == "palestine", "israel"),
         study_country = replace(study_country, study_country == "taiwan", "china")
  )

# Get iso3c codes for countries
events %<>%
  mutate(iso3c = countrycode(sourcevar = study_country,
                             origin = "country.name",
                             destination = "iso3c"))

# Summarize counts
events_by_country <- events %>%
  group_by(iso3c) %>%
  count(name = "n_amr_events") %>%
  ungroup() %>%
  na.omit()
#-----------------World Bank data-----------------
# Population and GDP
# SP.POP.TOTL = Population, total
# NY.GDP.MKTP.CD = GDP (current US$)
# AG.LND.AGRI.ZS = Agricultural land (% of land area)
# AG.PRD.LVSK.XD = Livestock production index (2004-2006 = 100)
# SH.XPD.CHEX.GD.ZS = Current health expenditure (% of GDP)

indicator = c("SP.POP.TOTL",     
              "NY.GDP.MKTP.CD",
              "AG.LND.AGRI.ZS",
              "AG.PRD.LVSK.XD",
              "SH.XPD.CHEX.GD.ZS")

wbd <- map_df(indicator, function(x){
  tmp <- fromJSON(paste0("http://api.worldbank.org/v2/country/all/indicator/", x, "?date=2015:2015&per_page=20000&format=json"))
  tmp[[2]] %>% 
    select(value, countryiso3code) %>%
    mutate(param = tmp[[2]][[1]]$id) %>%
    as_tibble() %>%
    filter(countryiso3code != "")
})

wbd %<>%
  spread(key = param, value = value) %>%
  rename(wb_population = SP.POP.TOTL,
         wb_gdp_dollars = NY.GDP.MKTP.CD,
         wb_ag_land_perc = AG.LND.AGRI.ZS,
         wb_livestock_index = AG.PRD.LVSK.XD,
         wb_health_expend_perc = SH.XPD.CHEX.GD.ZS,
         iso3c = countryiso3code)

#-----------------Observatory of Economic Complexity------------
# Visualization: https://atlas.media.mit.edu/en/visualize/tree_map/hs92/export/show/all/2941/2015/
oec <- read_json("https://atlas.media.mit.edu/hs92/export/2015/show/all/2941/")$data 
oec <- map_df(oec, function(x){
  
  import <- ifelse(is.null(x$import_val), 0, x$import_val)
  export <- ifelse(is.null(x$export_val), 0, x$export_val)
  
  tibble(iso3c = toupper(substr(x$origin_id, 3, 5)), oec_ab_import = import, oec_ab_export = export)
})

#-----------------Pubcrawler data-----------------
pubcrawl_weights <- read_csv(h("pubcrawler_country.csv")) %>% # generated by Toph on 2/1/19
  mutate(country = tolower(country),
         country = fct_recode(country, 
                              belize = "belice", 
                              brazil = "brasil",
                              `central african republic` = "cen african rep", 
                              `czech republic` = "czech r",
                              `dominican republic` = "dominican r", 
                              `united kingdom` = "england",
                              mauritania = "mauretania", 
                              morocco = "moracco",
                              `western sahara` = "morocco (includes western sahara)",
                              philippines = "philippine", 
                              tunisia = "tunesia"),
         iso3c = countrycode(sourcevar = country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  select(-country)

#-----------------All countries-----------------
all_countries <- map_data("world") %>%
  mutate(iso3c = countrycode(sourcevar = region,
                             origin = "country.name",
                             destination = "iso3c"))  %>%
  select(iso3c) %>% distinct() 
#-----------------Language by country-----------------
lang <- read_csv(h("wikipedia-language-by-country.csv"), skip = 1) %>% # convered 3/18/19 with https://wikitable2csv.ggor.de/
  select(Country, `Official language`) %>%
  mutate(english_spoken = grepl("English", `Official language`, ignore.case = TRUE),
         iso3c = countrycode(sourcevar = Country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  na.omit() %>%
  select(iso3c, english_spoken)
  

#-----------------All data-----------------
amr <- all_countries %>%
  left_join(events_by_country) %>%
  left_join(pubcrawl_weights) %>%
  left_join(wbd) %>%
  left_join(oec) %>%
  left_join(lang) %>%
  mutate(n_amr_events = ifelse(is.na(n_amr_events), 0 , n_amr_events),
         country = countrycode::countrycode(sourcevar = iso3c,
                                            origin = "iso3c",
                                            destination = "country.name"), 
         region = countrycode::countrycode(sourcevar = iso3c,
                                            origin = "iso3c",
                                            destination = "region"), 
         continent = countrycode::countrycode(sourcevar = iso3c,
                                              origin = "iso3c",
                                              destination = "continent"))




write_csv(amr, h("country_level_amr.csv"))
